name: Safe Repository Cleanup

on:
  schedule:
    - cron: '0 2 1 * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (test without deleting)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Read repositories to delete
        id: read_repos
        run: |
          if [ ! -f repos-to-delete.txt ]; then
            echo "repos-to-delete.txt not found!"
            exit 1
          fi
          
          repos=$(grep -v '^#' repos-to-delete.txt | grep -v '^$' || true)
          
          if [ -z "$repos" ]; then
            echo "âœ“ No repositories to delete. The list is empty."
            echo "count=0" >> $GITHUB_OUTPUT
            echo "repos=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Repository list:"
          echo "$repos"
          
          # Count repos
          count=$(echo "$repos" | wc -l)
          echo "count=$count" >> $GITHUB_OUTPUT
          
          # Convert to space-separated
          repos_space=$(echo "$repos" | tr '\n' ' ')
          echo "repos=$repos_space" >> $GITHUB_OUTPUT
      
      - name: Safety check
        run: |
          repo_count=${{ steps.read_repos.outputs.count }}
          
          if [ "$repo_count" -eq 0 ]; then
            echo "âœ“ No repositories to process. Exiting gracefully."
            exit 0
          fi
          
          if [ $repo_count -gt 10 ]; then
            echo "âš ï¸  WARNING: Attempting to delete $repo_count repositories"
            echo "Safety limit is 10 repositories per run."
            echo "Please reduce the number of repositories or increase the limit in the workflow."
            exit 1
          fi
          
          echo "âœ“ Safety check passed: $repo_count repositories to process"
      
      - name: Verify repositories exist
        id: verify_repos
        if: steps.read_repos.outputs.count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPOS_TO_DELETE: ${{ steps.read_repos.outputs.repos }}
        run: |
          echo "Verifying repositories..."
          existing_repos=""
          missing_repos=""
          
          for repo in $REPOS_TO_DELETE; do
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$repo")
            
            if [ "$response" -eq 200 ]; then
              echo "âœ“ Found: $repo"
              existing_repos="$existing_repos $repo"
            else
              echo "âš  Not found or inaccessible: $repo (HTTP $response)"
              missing_repos="$missing_repos $repo"
            fi
          done
          
          # Output results
          echo "existing=$existing_repos" >> $GITHUB_OUTPUT
          echo "missing=$missing_repos" >> $GITHUB_OUTPUT
          
          # Summary
          existing_count=$(echo $existing_repos | wc -w)
          missing_count=$(echo $missing_repos | wc -w)
          
          echo ""
          echo "Summary:"
          echo "  - Repositories found: $existing_count"
          echo "  - Repositories missing: $missing_count"
          
          if [ -n "$missing_repos" ]; then
            echo ""
            echo "âš ï¸ The following repositories are already deleted or inaccessible:"
            echo "$missing_repos" | tr ' ' '\n' | sed 's/^/  - /'
          fi
      
      - name: Get repository count before deletion
        id: count_before
        if: steps.read_repos.outputs.count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          username=$(echo "${{ steps.read_repos.outputs.repos }}" | head -n 1 | cut -d'/' -f1)
          
          total_repos=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/users/$username" | jq -r '.public_repos')
          
          echo "total_repos=$total_repos" >> $GITHUB_OUTPUT
          echo "Total repositories before deletion: $total_repos"
      
      - name: Delete repositories
        id: delete_repos
        if: steps.read_repos.outputs.count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPOS_TO_DELETE: ${{ steps.verify_repos.outputs.existing }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          if [ -z "$REPOS_TO_DELETE" ]; then
            echo "âš ï¸ No valid repositories to delete. All repositories are already deleted or inaccessible."
            echo "deleted_count=0" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "ðŸ” DRY RUN MODE - No repositories will be deleted"
            echo ""
          fi
          
          deleted_repos=""
          failed_repos=""
          deleted_count=0
          failed_count=0
          
          for repo in $REPOS_TO_DELETE; do
            echo "Processing: $repo"
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "  [DRY RUN] Would delete: $repo"
              continue
            fi
            
            # Delete the repository
            response=$(curl -X DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -w "%{http_code}" \
              -o /dev/null \
              -s \
              "https://api.github.com/repos/$repo")
            
            if [ "$response" -eq 204 ]; then
              echo "  âœ“ Successfully deleted: $repo"
              deleted_repos="$deleted_repos$repo"$'\n'
              deleted_count=$((deleted_count + 1))
            elif [ "$response" -eq 404 ]; then
              echo "  âš  Repository not found (may have been deleted between verification and deletion): $repo"
              deleted_repos="$deleted_repos$repo"$'\n'
              deleted_count=$((deleted_count + 1))
            elif [ "$response" -eq 403 ]; then
              echo "  âœ— Permission denied: $repo"
              failed_repos="$failed_repos$repo"$'\n'
              failed_count=$((failed_count + 1))
            else
              echo "  âœ— Failed to delete $repo (HTTP $response)"
              failed_repos="$failed_repos$repo"$'\n'
              failed_count=$((failed_count + 1))
            fi
            
            # Rate limiting: wait 1 second between deletions
            sleep 1
          done
          
          echo "deleted_count=$deleted_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
          {
            echo 'deleted_repos<<EOF'
            echo "$deleted_repos"
            echo EOF
          } >> $GITHUB_OUTPUT
          {
            echo 'failed_repos<<EOF'
            echo "$failed_repos"
            echo EOF
          } >> $GITHUB_OUTPUT
      
      - name: Get repository count after deletion
        id: count_after
        if: success() && github.event.inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          username=$(echo "${{ steps.read_repos.outputs.repos }}" | head -n 1 | cut -d'/' -f1)
          
          # Wait a moment for GitHub to update
          sleep 3
          
          total_repos=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/users/$username" | jq -r '.public_repos')
          
          echo "total_repos=$total_repos" >> $GITHUB_OUTPUT
          echo "Total repositories after deletion: $total_repos"
      
      - name: Create cleanup report
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          mkdir -p reports
          report_file="reports/cleanup-$(date +%Y%m%d-%H%M%S).md"
          
          before_count="${{ steps.count_before.outputs.total_repos }}"
          after_count="${{ steps.count_after.outputs.total_repos }}"
          deleted_count="${{ steps.delete_repos.outputs.deleted_count }}"
          failed_count="${{ steps.delete_repos.outputs.failed_count }}"
          
          # Calculate percentages and bar widths
          if [ "$before_count" -gt 0 ]; then
            deleted_percent=$((deleted_count * 100 / before_count))
            remaining_percent=$((after_count * 100 / before_count))
          else
            deleted_percent=0
            remaining_percent=0
          fi
          
          # Create progress bars (max 50 chars wide)
          deleted_bar_width=$((deleted_count * 50 / (before_count > 0 ? before_count : 1)))
          remaining_bar_width=$((after_count * 50 / (before_count > 0 ? before_count : 1)))
          
          deleted_bar=$(printf 'â–ˆ%.0s' $(seq 1 $deleted_bar_width))
          remaining_bar=$(printf 'â–ˆ%.0s' $(seq 1 $remaining_bar_width))
          
          echo "# ðŸ“Š Repository Cleanup Report" > $report_file
          echo "" >> $report_file
          echo "**Date**: $(date)" >> $report_file
          echo "" >> $report_file
          
          echo "## ðŸ“ˆ Dashboard" >> $report_file
          echo "" >> $report_file
          echo "\`\`\`" >> $report_file
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $report_file
          echo "â•‘                    CLEANUP STATISTICS                     â•‘" >> $report_file
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" >> $report_file
          printf "â•‘  Before Cleanup    â”‚ %-35s â•‘\n" "$before_count repos" >> $report_file
          printf "â•‘  After Cleanup     â”‚ %-35s â•‘\n" "$after_count repos" >> $report_file
          printf "â•‘  Deleted           â”‚ %-35s â•‘\n" "$deleted_count repos" >> $report_file
          printf "â•‘  Failed            â”‚ %-35s â•‘\n" "$failed_count repos" >> $report_file
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $report_file
          echo "" >> $report_file
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ VISUAL BREAKDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" >> $report_file
          echo "â”‚                                                                 â”‚" >> $report_file
          printf "â”‚  Deleted    [%-50s] %3d%%  â”‚\n" "$deleted_bar" "$deleted_percent" >> $report_file
          printf "â”‚  Remaining  [%-50s] %3d%%  â”‚\n" "$remaining_bar" "$remaining_percent" >> $report_file
          echo "â”‚                                                                 â”‚" >> $report_file
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" >> $report_file
          echo "\`\`\`" >> $report_file
          echo "" >> $report_file
          
          echo "## ðŸ“Š Summary" >> $report_file
          echo "" >> $report_file
          echo "| Metric | Count | Percentage |" >> $report_file
          echo "|--------|-------|------------|" >> $report_file
          echo "| ðŸ“¦ Total Before | $before_count | 100% |" >> $report_file
          echo "| âœ… Successfully Deleted | $deleted_count | ${deleted_percent}% |" >> $report_file
          echo "| âŒ Failed to Delete | $failed_count | - |" >> $report_file
          echo "| ðŸ“¦ Total After | $after_count | ${remaining_percent}% |" >> $report_file
          echo "" >> $report_file
          
          if [ "$deleted_count" -gt 0 ]; then
            echo "## âœ… Successfully Deleted Repositories" >> $report_file
            echo "" >> $report_file
            echo '```' >> $report_file
            echo "${{ steps.delete_repos.outputs.deleted_repos }}" >> $report_file
            echo '```' >> $report_file
            echo "" >> $report_file
          fi
          
          if [ "$failed_count" -gt 0 ]; then
            echo "## âŒ Failed to Delete" >> $report_file
            echo "" >> $report_file
            echo '```' >> $report_file
            echo "${{ steps.delete_repos.outputs.failed_repos }}" >> $report_file
            echo '```' >> $report_file
          fi
          
          echo "Report created: $report_file"
          cat $report_file
      
      - name: Update repos-to-delete.txt
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          echo "# Repositories successfully deleted on $(date)" > repos-to-delete.txt
          echo "# Add new repositories to delete below (format: username/repo-name)" >> repos-to-delete.txt
          echo "" >> repos-to-delete.txt
      
      - name: Commit changes
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add repos-to-delete.txt reports/
          git diff --quiet && git diff --staged --quiet || git commit -m "Cleanup: Deleted ${{ steps.delete_repos.outputs.deleted_count }} repos | ${{ steps.count_after.outputs.total_repos }} repos remaining [$(date +%Y-%m-%d)]"
          git push